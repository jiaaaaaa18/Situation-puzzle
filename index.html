<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>🧠 本機 LLM 海龜湯遊戲</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #f0f5f9;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 { color: #333; }
    #game-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 700px;
      margin: 30px auto;
    }
    textarea, input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background: #007bff;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    #log {
      margin-top: 20px;
      text-align: left;
      background: #f9f9f9;
      border-radius: 8px;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>🥣 本機 LLM 海龜湯遊戲</h1>
  <div id="game-container">
    <button onclick="startGame()">🎲 產生新的海龜湯題目</button>
    <div id="riddle"></div>
    <input id="userInput" placeholder="請輸入你的推理或問題..." />
    <button onclick="askLLM()">提交</button>
    <div id="log"></div>
  </div>

  <script>
    let story = "";  // 存放海龜湯題目背景
    let conversation = ""; // 用來記錄對話上下文

    // 🧩 呼叫本機 Ollama
    async function callOllama(prompt) {
      const response = await fetch("http://127.0.0.1:11434/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "llama3.2",   // 你本機的模型名稱
          prompt: prompt,
          stream: false
        })
      });
      if (!response.ok) return "❌ 模型無回應：" + response.status;
      const data = await response.json();
      return data.response.trim();
    }

    // 🎲 開始新遊戲：讓模型生成一個海龜湯故事
    async function startGame() {
      document.getElementById("riddle").innerText = "AI 正在構思海龜湯題目中...";
      const prompt = `
你是一個海龜湯遊戲主持人。
請生成一個有趣、邏輯合理、但帶點懸疑的海龜湯情境。
格式如下：
「題目描述：...」
「真相：...」
請保留真相在內部記憶中，不要立即顯示，只顯示題目描述。`;
      
      const result = await callOllama(prompt);
      let match = result.match(/題目描述[:：]([\s\S]*?)真相[:：]/);
      if (match) {
        story = match[1].trim();
      } else {
        story = result.trim();  // fallback，不讓題目空掉
        console.warn("⚠️ 無法解析格式，使用原始回應內容：", result);
      }

      conversation = `海龜湯題目：${story}\n`;
      document.getElementById("riddle").innerText = `🕵️‍♂️ 題目：${story}`;
      document.getElementById("log").innerText = "（你可以開始提問或猜答案）";
    }

    // 💬 玩家提問或猜測
    async function askLLM() {
      const input = document.getElementById("userInput").value.trim();
      if (!input) return;
      document.getElementById("userInput").value = "";
      
      const log = document.getElementById("log");
      log.innerText += `\n👤 你：${input}`;
      
      const prompt = `
你是海龜湯遊戲的主持人。
題目是：「${story}」
玩家剛剛問或回答：「${input}」
請你根據題目邏輯給出提示或回應，
例如回答「是」「不是」「接近」「請換個角度想」等，
但不要直接說出真相。
`;
      const reply = await callOllama(prompt);
      log.innerText += `\n🤖 AI：${reply}\n`;
      log.scrollTop = log.scrollHeight;
    }
  </script>
</body>
</html>
