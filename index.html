<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æµ·é¾œæ¹¯çŒœè¬éŠæˆ²</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f0f5f9;
    text-align: center;
  }
  h1 {
    color: #333;
    margin-bottom: 10px;
  }
  #start-screen, #game-screen {
    display: none;
  }
  #start-screen.active, #game-screen.active {
    display: block;
  }
  button {
    padding: 10px 20px;
    font-size: 18px;
    margin-top: 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background-color: #007bff;
    color: white;
    transition: 0.3s;
  }
  button:hover {
    background-color: #0056b3;
  }
  #riddle {
    font-size: 20px;
    margin-top: 20px;
    min-height: 60px;
  }
  #response {
    margin-top: 10px;
    color: green;
    font-weight: bold;
  }
  #answer {
    padding: 5px;
    font-size: 16px;
    margin-top: 10px;
  }
  .explanation {
    margin-top: 20px;
    padding: 15px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    text-align: left;
  }
  .loading {
    color: gray;
    font-style: italic;
  }
</style>
</head>
<body>

<h1>ğŸ¥£ æµ·é¾œæ¹¯çŒœè¬éŠæˆ²</h1>

<!-- âœ… é–‹å§‹ç•«é¢ -->
<div id="start-screen" class="active">
  <p>æ­¡è¿ä¾†åˆ°æµ·é¾œæ¹¯éŠæˆ²ï¼</p>
  <p>AI æœƒå‡ºæ‡¸ç–‘çš„æƒ…å¢ƒé¡Œï¼Œè«‹ä½ é€éæ¨ç†å›ç­”èƒŒå¾ŒçœŸç›¸ï¼</p>
  <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
</div>

<!-- âœ… éŠæˆ²ç•«é¢ -->
<div id="game-screen">
  <div id="riddle" class="loading">ç­‰å¾… AI å‡ºé¡Œä¸­...</div>
  <input type="text" id="answer" placeholder="è¼¸å…¥ä½ çš„ç­”æ¡ˆ">
  <br>
  <button onclick="submitAnswer()">æäº¤</button>
  <div id="response"></div>

  <div class="explanation">
    <h3>ğŸ“˜ æµ·é¾œæ¹¯èªªæ˜ï¼š</h3>
    <p>æµ·é¾œæ¹¯æ˜¯ä¸€ç¨®æ¨ç†éŠæˆ²ã€‚å‡ºé¡Œè€…æœƒçµ¦å‡ºä¸€å€‹å¥‡æ€ªçš„æƒ…å¢ƒï¼Œ
       ç©å®¶è¦ä¸æ–·æå‡ºå•é¡Œæˆ–æ¨ç†å‡ºçœŸç›¸ã€‚  
       åœ¨é€™è£¡ï¼ŒAI æœƒè‡ªå‹•å‡ºé¡Œï¼Œè«‹ä½ å˜—è©¦å›ç­”å®ƒèƒŒå¾Œçš„åŸå› ï¼</p>
  </div>
</div>

<script>
// ===============================
// ğŸ”§ è¨­å®š Ollama ä¼ºæœå™¨ä½ç½®
// ===============================
// è‹¥åœ¨æœ¬æ©ŸåŸ·è¡Œï¼šä¿æŒ http://localhost:11434
// è‹¥ä½¿ç”¨ ngrokï¼Œæ”¹æˆä¾‹å¦‚ï¼š "https://abc123.ngrok.io/api/generate"
const OLLAMA_API = "https://unarguable-untampered-gil.ngrok-free.dev ";

// ===============================
// ğŸ§© éŠæˆ²é‚è¼¯
// ===============================
let currentRiddle = { q: "", a: "" };

// âœ… æ‰“å­—å‹•ç•«ï¼ˆè®“å‡ºé¡Œæ–‡å­—ä¸€å€‹å­—ä¸€å€‹å­—å‡ºç¾ï¼‰
function typeWriterEffect(element, text, speed = 30) {
  element.innerHTML = "";
  let i = 0;
  function type() {
    if (i < text.length) {
      element.innerHTML += text.charAt(i);
      i++;
      setTimeout(type, speed);
    }
  }
  type();
}

// âœ… è«‹ Ollama å‡ºé¡Œ
async function newRiddle() {
  const riddleEl = document.getElementById("riddle");
  const responseEl = document.getElementById("response");
  const answerInput = document.getElementById("answer");

  riddleEl.innerText = "ğŸ§  AI æ­£åœ¨å‡ºé¡Œä¸­...";
  responseEl.innerText = "";
  answerInput.value = "";

  const prompt = `
  ä½ æ˜¯ä¸€å€‹æµ·é¾œæ¹¯éŠæˆ²çš„å‡ºé¡Œè€…ã€‚è«‹ç”Ÿæˆä¸€å€‹æœ‰è¶£ã€æ‡¸ç–‘ã€ä½†é‚è¼¯åˆç†çš„é¡Œç›®ã€‚
  æ ¼å¼ï¼š
  é¡Œç›®ï¼šxxxx
  ç­”æ¡ˆï¼šxxxx
  ä¸è¦åŠ å…¥ä»»ä½•å¤šé¤˜çš„èªªæ˜æˆ–æ–‡å­—ã€‚
  `;

  try {
    const res = await fetch(OLLAMA_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "llama3.2",
        prompt: prompt
      })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let fullText = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      fullText += decoder.decode(value);
    }

    const match = fullText.match(/é¡Œç›®[:ï¼š](.*)\n*ç­”æ¡ˆ[:ï¼š](.*)/);
    if (match) {
      currentRiddle.q = match[1].trim();
      currentRiddle.a = match[2].trim();
    } else {
      currentRiddle.q = "AI å‡ºé¡Œå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚";
      currentRiddle.a = "";
    }

    typeWriterEffect(riddleEl, currentRiddle.q);
  } catch (err) {
    console.error(err);
    riddleEl.innerText = "âš ï¸ ç„¡æ³•é€£ç·šåˆ° Ollamaï¼Œè«‹ç¢ºèªæ˜¯å¦åŸ·è¡Œä¸­ã€‚";
  }
}

// âœ… é–‹å§‹éŠæˆ²
function startGame() {
  document.getElementById("start-screen").classList.remove("active");
  document.getElementById("game-screen").classList.add("active");
  newRiddle();
}

// âœ… æäº¤ç­”æ¡ˆä¸¦ç”¨ Ollama åˆ¤æ–·
async function submitAnswer() {
  const userAnswer = document.getElementById("answer").value.trim();
  const responseBox = document.getElementById("response");

  if (!userAnswer) {
    alert("è«‹å…ˆè¼¸å…¥ç­”æ¡ˆï¼");
    return;
  }

  responseBox.textContent = "AI åˆ¤æ–·ä¸­...";

  const checkPrompt = `
  é¡Œç›®ï¼šã€Œ${currentRiddle.q}ã€
  æ­£ç¢ºç­”æ¡ˆï¼šã€Œ${currentRiddle.a}ã€
  ä½¿ç”¨è€…å›ç­”ï¼šã€Œ${userAnswer}ã€
  è«‹åªå›ç­”ã€Œæ­£ç¢ºã€æˆ–ã€ŒéŒ¯èª¤ã€ï¼Œä¸è¦åŠ ä»»ä½•å…¶ä»–æ–‡å­—ã€‚
  `;

  try {
    const res = await fetch(OLLAMA_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "llama3.2",
        prompt: checkPrompt
      })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let fullText = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      fullText += decoder.decode(value);
    }

    if (fullText.includes("æ­£ç¢º")) {
      responseBox.textContent = "âœ… ç­”å°äº†ï¼å¤ªæ£’äº†ï¼";
    } else {
      responseBox.textContent = "âŒ éŒ¯èª¤ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼šã€Œ" + currentRiddle.a + "ã€ã€‚";
    }

    setTimeout(newRiddle, 4000);
  } catch (err) {
    console.error(err);
    responseBox.textContent = "âš ï¸ ç„¡æ³•é€£ç·šåˆ° Ollamaã€‚";
  }
}
</script>

</body>
</html>
