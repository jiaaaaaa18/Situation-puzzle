<script>
// é€™è£¡è¨­å®š Ollama çš„ä¼ºæœå™¨ä½ç½®
// æœ¬æ©Ÿæ¸¬è©¦æ™‚ç”¨ localhostï¼›è‹¥ç”¨ ngrok å°±æ”¹æˆ ngrok çµ¦çš„ç¶²å€ï¼Œä¾‹å¦‚ï¼š
// const OLLAMA_API = "https://abc123.ngrok.io/api/generate";
const OLLAMA_API = "https://unarguable-untampered-gil.ngrok-free.dev";

// å„²å­˜ç›®å‰çš„é¡Œç›®èˆ‡ç­”æ¡ˆ
let currentRiddle = { q: "", a: "" };

// å« Ollama å‡ºé¡Œ
async function newRiddle() {
  document.getElementById("riddle").innerText = "ğŸ§  AI æ­£åœ¨å‡ºé¡Œä¸­...";
  document.getElementById("response").innerText = "";
  document.getElementById("answer").value = "";

  const prompt = `
  ä½ æ˜¯ä¸€å€‹æµ·é¾œæ¹¯å‡ºé¡Œè€…ï¼Œè«‹ç”Ÿæˆä¸€å€‹æœ‰è¶£ã€æ‡¸ç–‘ä½†åˆé‚è¼¯çš„æµ·é¾œæ¹¯é¡Œç›®ã€‚
  æ ¼å¼å¦‚ä¸‹ï¼š
  é¡Œç›®ï¼šxxxx
  ç­”æ¡ˆï¼šxxxx
  ä¸è¦å¤šé¤˜æ–‡å­—ã€‚
  `;

  try {
    const res = await fetch(OLLAMA_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "llama3.2",
        prompt: prompt
      })
    });

    // Ollama æ˜¯ä»¥ä¸²æµå›å‚³çš„ï¼Œæˆ‘å€‘æŠŠå®ƒå®Œæ•´è®€å‡º
    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let fullText = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      fullText += decoder.decode(value);
    }

    // å¾å›å‚³æ–‡å­—ä¸­å–å‡ºé¡Œç›®èˆ‡ç­”æ¡ˆ
    const match = fullText.match(/é¡Œç›®[:ï¼š](.*)\n*ç­”æ¡ˆ[:ï¼š](.*)/);
    if (match) {
      currentRiddle.q = match[1].trim();
      currentRiddle.a = match[2].trim();
    } else {
      currentRiddle.q = "AI å‡ºé¡Œå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
      currentRiddle.a = "";
    }

    document.getElementById("riddle").innerText = currentRiddle.q;
  } catch (err) {
    console.error(err);
    document.getElementById("riddle").innerText =
      "âš ï¸ ç„¡æ³•é€£ç·šåˆ° Ollamaï¼Œè«‹ç¢ºèªæ˜¯å¦æœ‰åŸ·è¡Œ ollama serve æˆ–è¨­å®š ngrok URLã€‚";
  }
}

// é–‹å§‹éŠæˆ²
function startGame() {
  document.getElementById("start-screen").classList.remove("active");
  document.getElementById("game-screen").classList.add("active");
  newRiddle();
}

// ä½¿ç”¨è€…æäº¤ç­”æ¡ˆ
async function submitAnswer() {
  const userAnswer = document.getElementById("answer").value.trim();
  const responseBox = document.getElementById("response");

  if (!userAnswer) {
    alert("è«‹å…ˆè¼¸å…¥ç­”æ¡ˆï¼");
    return;
  }

  responseBox.textContent = "AI åˆ¤æ–·ä¸­...";

  // å‘¼å« Ollama åˆ¤æ–·ç©å®¶ç­”æ¡ˆæ˜¯å¦æ­£ç¢º
  const checkPrompt = `
  é¡Œç›®ï¼šã€Œ${currentRiddle.q}ã€
  æ­£ç¢ºç­”æ¡ˆï¼šã€Œ${currentRiddle.a}ã€
  ä½¿ç”¨è€…çš„å›ç­”ï¼šã€Œ${userAnswer}ã€
  è«‹åªå›ç­”ã€Œæ­£ç¢ºã€æˆ–ã€ŒéŒ¯èª¤ã€ï¼Œä¸éœ€è¦å¤šé¤˜èªªæ˜ã€‚
  `;

  try {
    const res = await fetch(OLLAMA_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "llama3.2",
        prompt: checkPrompt
      })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let fullText = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      fullText += decoder.decode(value);
    }

    if (fullText.includes("æ­£ç¢º")) {
      responseBox.textContent = "âœ… ç­”å°äº†ï¼å¤ªæ£’äº†ï¼";
    } else {
      responseBox.textContent = "âŒ éŒ¯èª¤ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼šã€Œ" + currentRiddle.a + "ã€ã€‚";
    }

    setTimeout(newRiddle, 3000);
  } catch (err) {
    console.error(err);
    responseBox.textContent = "âš ï¸ åˆ¤æ–·å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Ollama æ˜¯å¦é‹è¡Œä¸­ã€‚";
  }
}
</script>
